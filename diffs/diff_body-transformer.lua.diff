21,22d20
< local multipart         = require("multipart")
< 
34d31
< local setmetatable      = setmetatable
40,43c37
<         input_format = {
<             type = "string",
<             enum = {"xml", "json", "encoded", "args", "plain", "multipart",}
<         },
---
>         input_format = { type = "string", enum = {"xml", "json", "encoded", "args", "plain"} },
74,77c68,71
<             :gsub("<", "&lt;")
<             :gsub(">", "&gt;")
<             :gsub("'", "&apos;")
<             :gsub('"', "&quot;")
---
>         :gsub("<", "&lt;")
>         :gsub(">", "&gt;")
>         :gsub("'", "&apos;")
>         :gsub('"', "&quot;")
127,130d120
<     multipart = function (data, content_type_header)
<         local res = multipart(data, content_type_header)
<         return res
<     end
141,142d130
<     local _multipart
< 
144,148d131
<     local ct = ctx.var.http_content_type
<     if typ == "response" then
<         ct = ngx.header.content_type
<     end
< 
152,156c135
<             out, err = decoders[format](body, ct)
<             if format == "multipart" then
<                 _multipart = out
<                 out = out:get_all_with_arrays()
<             end
---
>             out, err = decoders[format](body)
179,186c158,161
<     setmetatable(out, {__index = {
<         _ctx = ctx,
<         _body = body,
<         _escape_xml = escape_xml,
<         _escape_json = escape_json,
<         _multipart = _multipart,
<     }})
< 
---
>     out._ctx = ctx
>     out._body = body
>     out._escape_xml = escape_xml
>     out._escape_json = escape_json
210,211d184
<         elseif str_find(ct:lower(), "multipart/", nil) then
<             conf[typ].input_format = "multipart"
247,249d219
<     if not conf then
<         return
<     end
